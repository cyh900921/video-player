<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Canvas Video Player</title>
<style>
  body {
    background:black; margin:0;
    display:flex; flex-direction:column;
    justify-content:center; align-items:center;
    height:100vh;
  }
  canvas {
    background:black;
    max-width:100vw;
    max-height:80vh;
  }
  .controls {
    margin-top:20px;
    display:flex; gap:20px;
  }
  button {
    padding:20px 40px;
    font-size:24px;
    background:#444; color:white;
    border:none; border-radius:10px;
  }
  button:disabled {
    background:#222;
    color:#777;
  }
</style>
</head>

<body>

<video id="v" playsinline muted
  style="position:absolute; left:-9999px; top:-9999px; width:1px; height:1px;"
>
  <source src="ÂÆåÊï¥ÂΩ±Áâá.mp4" type="video/mp4">
</video>

<canvas id="c"></canvas>

<div class="controls">
  <button id="startBtn" onclick="startPlayback()">‚ñ∂Ô∏è ÈñãÂßãÊí≠Êîæ</button>
  <button onclick="exitPage()">‚ùå Èõ¢Èñã</button>
</div>

<script>
const video = document.getElementById("v");
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let playing = false;
let loopCount = 0;
const MAX_LOOP = 3;

const startBtn = document.getElementById("startBtn");

// ============================
// ‚≠ê 1) ËºâÂÖ•ÂæåÊí≠Êîæ 0.1 ÁßíÊäìÁ¨¨‰∏ÄÂπÄ
// ============================
video.addEventListener("loadedmetadata", () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  video.muted = true;
  video.currentTime = 0;

  video.play().then(() => {
    setTimeout(() => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      video.pause();
      video.currentTime = 0;
    }, 120);
  });
});

// ============================
// ‚≠ê Êí≠ÊîæÂæ™Áí∞
// ============================
function draw() {
  if (playing) {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    requestAnimationFrame(draw);
  }
}

video.addEventListener("ended", () => {
  loopCount++;
  if (loopCount < MAX_LOOP) {
    video.currentTime = 0;
    video.play();
  } else {
    playing = false;
    startBtn.textContent = "üîÅ ÈáçË§áÊí≠Êîæ";
    startBtn.disabled = false;
  }
});

// ============================
// ‚≠ê ÈñãÂßãÊí≠ÊîæÔºàÊåâÈàïËß∏Áôº ‚Üí ÊúâËÅ≤Èü≥Ôºâ
// ============================
function startPlayback() {
  loopCount = 0;
  playing = true;

  video.muted = false;
  video.currentTime = 0;
  video.play();

  draw();

  startBtn.disabled = true;
}

// ============================
// ‚≠ê Èõ¢ÈñãÊåâÈàï
// ============================
function exitPage() {
  // 1. Ë©¶ËëóÈóúÈñâÈ†ÅÈù¢ÔºàÂ¶ÇÊûúÈ†ÅÈù¢ÊòØÁî± JS ÊâìÈñãÁöÑÊúÉÊàêÂäüÔºâ
  window.close();

  // 2. Â¶ÇÊûúÈóúÈñâË¢´ÈòªÊìã ‚Üí Ëá™ÂãïÂõû‰∏ä‰∏ÄÈ†ÅÔºàiPhone ÊúÉËµ∞ÈÄôË£°Ôºâ
  setTimeout(() => {
    history.back();
  }, 50);
}
</script>

</body>
</html>
